const mergeIntoSlice=(t,e,n)=>{let o=n[0],{position:r,word:l}=o;const i=[],s=new Set;for(;r+l.length<=e&&0!==n.length;){s.add(l),i.push({position:r,length:l.length});const t=r+l.length;for(n.shift();0!==n.length&&(r=(o=n[0]).position,l=o.word,t>r);)n.shift()}return{hits:i,start:t,end:e,count:s.size}},getIndexByWord=(t,e,n=!1)=>{const o=[],r=new Set;return t.forEach(t=>{const l=t.length;if(0===l)return;let i=0,s=-1;for(n||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,i))>-1;)o.push({position:s,word:t}),r.add(t),i=s+l}),o.sort((t,e)=>t.position!==e.position?t.position-e.position:e.word.length-t.word.length),[o,r]},highlightKeyword=(t,e)=>{let n="",o=e.start;for(const{position:r,length:l}of e.hits)n+=t.substring(o,r),o=r+l,n+=`<mark class="search-keyword">${t.substr(r,l)}</mark>`;return n+=t.substring(o,e.end)},localSearch=(t,e,n)=>{if(!t)return void console.warn("`hexo-generator-searchdb` plugin is not installed!");let o=[];const r=document.getElementById(e),l=document.getElementById(n);(()=>{const e=!t.endsWith("json");fetch(t).then(t=>t.text()).then(t=>{o=(o=e?[...(new DOMParser).parseFromString(t,"text/xml").querySelectorAll("entry")].map(t=>({title:t.querySelector("title").textContent,content:t.querySelector("content").textContent,url:t.querySelector("url").textContent})):JSON.parse(t)).filter(t=>t.title).map(t=>(t.title=t.title.trim(),t.content=t.content?t.content.trim().replace(/<[^>]+>/g,""):"",t.url=decodeURIComponent(t.url).replace(/\/{2,}/g,"/"),t)),r&&r.addEventListener("input",()=>{const t=r.value.trim().toLowerCase(),e=t.split(/[-\s]+/);let n=[];t.length>0&&(n=(t=>{const e=[];return o.forEach(({title:n,content:o,url:r})=>{const[l,i]=getIndexByWord(t,n),[s,h]=getIndexByWord(t,o),c=new Set([...i,...h]).size,a=l.length+s.length;if(0===a)return;const u=[];0!==l.length&&u.push(mergeIntoSlice(0,n.length,l));let d=[];for(;0!==s.length;){const t=s[0],{position:e}=t,n=Math.max(0,e-20),r=Math.min(o.length,e+80);d.push(mergeIntoSlice(n,r,s))}d.sort((t,e)=>t.count!==e.count?e.count-t.count:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start);let g="";(r=new URL(r,location.origin)).searchParams.append("highlight",t.join(" ")),0!==u.length?g+=`<li><a href="${r.href}" class="search-result-title">${highlightKeyword(n,u[0])}</a>`:g+=`<li><a href="${r.href}" class="search-result-title">${n}</a>`,d.forEach(t=>{g+=`<a href="${r.href}"><p class="search-result">${highlightKeyword(o,t)}...</p></a>`}),g+="</li>",e.push({item:g,id:e.length,hitCount:a,includedCount:c})}),e})(e)),n.sort((t,e)=>t.includedCount!==e.includedCount?e.includedCount-t.includedCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id);const i=CONFIG.i18n.hits.replace(/\$\{hits}/,n.length);l.innerHTML=`<div class="search-stats">${i}</div>\n            <ul class="search-result-list">${n.map(t=>t.item).join("")}</ul>`})})})()};document.addEventListener("DOMContentLoaded",()=>{localSearch(CONFIG.local_search.path,"local-search-input","local-search-result")});